{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:recommended"
  ],
  "helmv3": {
    "fileMatch": [
      "charts/**/values*.yaml",
      "charts/**/values*.yml",
      "charts/**/values/**/*.yml",
      "charts/**/values/**/*.yaml"
    ]
  },
  "regexManagers": [
    {
      "fileMatch": [
        "charts/**/values*.yaml",
        "charts/**/values*.yml",
        "charts/**/values/**/*.yml",
        "charts/**/values/**/*.yaml"
      ],
      "matchStrings": [
        "registry:\\s+(?<registry>ghcr\\.io\/[^\\n]+)\\n\\s*repository:\\s+(?<depName>[^\\n]+)\\n[\\s\\S]*?tag:\\s+[\"']?(?<currentValue>[^\"'\\n]+)[\"']?",
        "tag:\\s+[\"']?(?<currentValue>[^\"'\\n]+)[\"']?\\s*#\\s*renovate:\\s*(?<registry>[^\\s]+)\/(?<depName>[^\\s]+)"
      ],
      "datasourceTemplate": "docker",
      "registryUrlTemplate": "https://{{registry}}",
      "depNameTemplate": "{{registry}}/{{depName}}"
    }
  ],
  "packageRules": [
    {
      "description": "Test environment - track main-* tags",
      "matchFileNames": ["**/values/test/**"],
      "matchDatasources": ["docker"],
      "matchPackageNames": ["ghcr.io/benhesketh21/**"],
      "versioning": "regex:^main-(?<major>\\d+)$",
      "extractVersion": "^main-(?<version>.*)$",
      "automerge": true,
      "labels": ["test-env", "main-branch-update"],
      "rangeStrategy": "replace"
    },
    {
      "description": "Staging/Prod environments - track semver tags",
      "matchFileNames": ["**/values/staging/**", "**/values/prod/**"],
      "matchDatasources": ["docker"],
      "matchPackageNames": ["ghcr.io/benhesketh21/**"],
      "versioning": "regex:^v?(?<major>\\d+)\\.(?<minor>\\d+)\\.(?<patch>\\d+)(-(?<prerelease>.*))?$",
      "separateMinorPatch": true,
      "rangeStrategy": "replace"
    },
    {
      "description": "Staging/Prod - Major version updates need approval",
      "matchFileNames": ["**/values/staging/**", "**/values/prod/**"],
      "matchDatasources": ["docker"],
      "matchPackageNames": ["ghcr.io/benhesketh21/**"],
      "matchUpdateTypes": ["major"],
      "automerge": false,
      "labels": ["staging-prod", "major-update"]
    },
    {
      "description": "Staging/Prod - Minor/patch updates can auto-merge",
      "matchFileNames": ["**/values/staging/**", "**/values/prod/**"],
      "matchDatasources": ["docker"],
      "matchPackageNames": ["ghcr.io/benhesketh21/**"],
      "matchUpdateTypes": ["minor", "patch"],
      "automerge": true,
      "labels": ["staging-prod", "minor-patch-update"]
    },
    {
      "description": "Default values.yaml files - use semver for safety",
      "matchFileNames": ["**/values.yaml", "**/values.yml"],
      "excludeFileNames": ["**/values/test/**", "**/values/staging/**", "**/values/prod/**"],
      "matchDatasources": ["docker"],
      "matchPackageNames": ["ghcr.io/benhesketh21/**"],
      "versioning": "regex:^v?(?<major>\\d+)\\.(?<minor>\\d+)\\.(?<patch>\\d+)(-(?<prerelease>.*))?$",
      "automerge": false,
      "labels": ["default-values"]
    }
  ]
}
